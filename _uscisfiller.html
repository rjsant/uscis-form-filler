<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>USCIS PDF Filler - Responsive</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
      flex-direction: row;
    }

    #pdfPane {
      min-width: 250px;
      max-width: 90vw;
      width: 50%;
      padding: 1rem;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
    }

    iframe {
      flex: 1;
      width: 100%;
      border: 1px solid #ccc;
    }

    #formPane {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      background: #f7f7f7;
    }

    .resizer {
      width: 5px;
      background: #ccc;
      cursor: ew-resize;
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      cursor: ew-resize;
    }

    fieldset {
      margin-bottom: 1rem;
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
    }

    .inline-inputs {
      display: flex;
      gap: 0.5em;
    }

    .inline-inputs input {
      width: 3em;
    }

    input, select, button {
      padding: 0.4em;
      font-size: 1em;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 0.5em;
      cursor: pointer;
      margin-top: 1rem;
    }

    button:hover {
      background-color: #0056b3;
    }

    .switch {
      display: flex;
      align-items: center;
      gap: 0.5em;
      margin: 1rem 0;
    }

    /* The Update Preview button is now always visible */
    #manualPreviewBtn {
      margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      #pdfPane {
        width: 100%;
        min-height: 40vh;
        max-height: 60vh;
      }
      .resizer {
        height: 5px;
        width: 100%;
        cursor: ns-resize;
      }
    }
  </style>
</head>
<body>
  <div id="overlay"></div>

  <div class="container">
    <div id="pdfPane">
      <iframe id="pdfPreview"></iframe>
    </div>
    <div class="resizer" id="resizer"></div>
    <div id="formPane">
      <h2>USCIS Form</h2>

      <label>Select a Form:
        <select id="formSelect">
          <option value="i912_conv.pdf" selected>I-912</option>
          <option value="n400_conv.pdf">N-400</option>
          <option value="n600_conv.pdf">N-600</option>
        </select>
      </label>

      <!-- Update Preview button is now visible -->
      <button type="button" id="manualPreviewBtn">Update Preview</button>

      <form id="uscis-form">
        <fieldset>
          <legend>Name</legend>
          <label>First Name: <input type="text" id="firstName" /></label>
          <label>Middle Name: <input type="text" id="middleName" /></label>
          <label>Last Name: <input type="text" id="lastName" /></label>
        </fieldset>

        <fieldset>
          <legend>SSN</legend>
          <input type="text" id="ssn" maxlength="11" placeholder="123-45-6789"/>
        </fieldset>

        <fieldset>
          <legend>Sex</legend>
          <label><input type="radio" name="sex" value="M" /> Male</label>
          <label><input type="radio" name="sex" value="F" /> Female</label>
          <label><input type="radio" name="sex" value="N" /> Nonbinary</label>
        </fieldset>

        <fieldset>
          <legend>Phone</legend>
          <input type="text" id="phone" maxlength="15" placeholder="555-123-4567"/>
        </fieldset>

        <fieldset>
          <legend>Contact Info</legend>
          <label>Email: <input type="email" id="email" /></label>
        </fieldset>

        <fieldset>
          <legend>Address</legend>
          <label>Street: <input type="text" id="mailAddress" /></label>
          <label>City: <input type="text" id="mailCity" /></label>
          <label>State: <input type="text" id="mailState" /></label>
          <label>ZIP: <input type="text" id="mailZip" /></label>
        </fieldset>

        <button type="submit">Download Filled PDF</button>
      </form>
    </div>
  </div>

  <script>
    const pdfPreview = document.getElementById("pdfPreview");
    const formSelect = document.getElementById("formSelect");
    const manualBtn = document.getElementById("manualPreviewBtn");
    const resizer = document.getElementById("resizer");
    const pdfPane = document.getElementById("pdfPane");
    const overlay = document.getElementById("overlay");

    let originalPdfBytes = null;
    let font = null;
    let isResizing = false;

    resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      overlay.style.display = 'block';
      document.body.style.cursor = 'ew-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const newWidth = e.clientX;
      if (newWidth > 250 && newWidth < window.innerWidth - 250) {
        pdfPane.style.width = `${newWidth}px`;
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        overlay.style.display = 'none';
        document.body.style.cursor = 'default';
      }
    });

    async function loadPDF(filename) {
      const res = await fetch(filename);
      originalPdfBytes = await res.arrayBuffer();
      await updatePreview();
    }

    async function updatePreview() {
      if (!originalPdfBytes) return;
      const pdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes, { ignoreEncryption: true });
      const page = pdfDoc.getPages()[0];
      if (!font) font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

      const draw = (text, x, y) => page.drawText(text, { x, y, size: 10, font });
      const val = id => document.getElementById(id)?.value || "";

      draw(val("firstName"), 50, 700);
      draw(val("middleName"), 150, 700);
      draw(val("lastName"), 300, 700);
      draw(document.querySelector("input[name='sex']:checked")?.value || "", 50, 680);
      draw(val("ssn"), 50, 660);
      draw(val("phone"), 50, 640);
      draw(val("email"), 50, 625);
      draw(val("mailAddress"), 50, 610);
      draw(val("mailCity"), 50, 595);
      draw(val("mailState"), 200, 595);
      draw(val("mailZip"), 350, 595);

      const pdfBytes = await pdfDoc.save();
      const url = URL.createObjectURL(new Blob([pdfBytes], { type: "application/pdf" }));
      pdfPreview.src = url;
    }

    // When the form is submitted, update the preview and download the updated PDF.
    document.getElementById("uscis-form").addEventListener("submit", async e => {
      e.preventDefault();
      await updatePreview();
      const a = document.createElement("a");
      a.href = pdfPreview.src;
      a.download = "filled_form.pdf";
      a.click();
    });

    formSelect.addEventListener("change", e => {
      loadPDF(e.target.value);
    });

    manualBtn.addEventListener("click", updatePreview);

    document.addEventListener("DOMContentLoaded", () => {
      if (formSelect && formSelect.value) loadPDF(formSelect.value);
    });
  </script>
</body>
</html>
